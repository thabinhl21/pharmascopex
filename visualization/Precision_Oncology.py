import streamlit as st
import pandas as pd
import joblib
import matplotlib.pyplot as plt
import plotly.express as px

st.title('Precision Oncology')
st.write('##### Find out which drugs are most effective against a chosen cell line using the dropdown menu below')

# cell_lines = ['ES5', 'ES7', 'EW-11', 'SK-ES-1', 'COLO-829', '8-MG-BA', 'GB-1', 'U-87-MG', 'NCI-H720', 'NCI-H1648', 'NCI-H1650', 'NCI-H1770', 'NCI-H1838', 'DMS-114', 'NCI-H1092', 'NCI-H1694', 'NCI-H187', 'NCI-H1963', 'NCI-H209', 'NCI-H2141', 'NCI-H2171', 'NCI-H2227', 'NCI-H345', 'NCI-H446', 'NCI-H526', 'NCI-H64', 'NCI-H69', 'NCI-H82', 'SK-N-DZ', 'SK-N-FI', 'VA-ES-BJ', 'LU-139', 'SBC-1', 'Calu-6', 'LU-65', 'NCI-H1355', 'SHP-77', 'TE-5', 'HCC1187', 'HCC1599', 'HCC2157', 'HCC2218', 'BB30-HNC', 'BB49-HNC', 'CP66-MEL', 'CPC-N', 'CTV-1', 'D-542MG', 'DMS-79', 'DSH1', 'EC-GI-10', 'HA7-RCC', 'IM-9', 'IST-SL1', 'IST-SL2', 'LB1047-RCC', 'LB2241-RCC', 'LB2518-MEL', 'LB373-MEL-D', 'LB647-SCLC', 'LB771-HNC', 'LB831-BLC', 'LB996-RCC', 'LU-134-A', 'LU-165', 'LXF-289', 'MS-1', 'MZ1-PC', 'MZ7-mel', 'NCI-H128', 'NCI-H1304', 'NCI-H510A', 'SK-MM-2', 'TE-15', 'U-266', 'BE2-M17', 'KELLY', 'SIMA', 'TE-1', 'TE-10', 'TE-8', 'HL-60', 'K-562', 'NCI-H226', 'NCI-H23', 'CCRF-CEM', 'SK-MEL-2', 'MOLT-4', 'RPMI-8226', 'SR', 'NCI-H322M', 'EKVX', 'HCC2998', 'HOP-62', 'LOXIMVI', 'UACC-257', 'RXF393', 'TK10', 'SNB75', 'SF539', 'SF268', 'KM12', 'OVCAR-4', 'Becker', 'BE-13', 'ARH-77', 'A253', '697', 'COR-L88', 'COLO-824', 'COLO-800', 'Daudi', 'DB', 'D-283MED', 'DEL', 'DG-75', 'DJM-1', 'DOHH-2', 'DU-4475', 'EB2', 'EB-3', 'ECC12', 'EHEB', 'EM-2', 'EoL-1-cell', 'ETK-1', 'EVSA-T', 'GCIY', 'GDM-1', 'GI-1', 'GI-ME-N', 'GOTO', 'GR-ST', 'H9', 'HC-1', 'HEL', 'HH', 'HT', 'HT-144', 'HuTu-80', 'IMR-5', 'IST-MEL1', 'IST-MES1', 'JAR', 'JiyoyeP-2003', 'JVM-2', 'JVM-3', 'KALS-1', 'KARPAS-45', 'KARPAS-299', 'KARPAS-422', 'KASUMI-1', 'KE-37', 'KG-1', 'KINGS-1', 'KMOE-2', 'KNS-42', 'H-EMC-SS', 'KY821', 'KU812', 'KS-1', 'KP-N-YN', 'L-428', 'L-540', 'LAMA-84', 'LC-2-ad', 'LC4-1', 'LNCaP-Clone-FGC', 'LOUCY', 'LP-1', 'LS-123', 'LS-411N', 'LS-513', 'MC116', 'MEG-01', 'MHH-NB-11', 'MHH-PREB-1', 'ML-2', 'MLMA', 'MN-60', 'MOLT-16', 'MONO-MAC-6', 'Mo-T', 'MPP-89', 'MRK-nu-1', 'MSTO-211H', 'MV-4-11', 'NALM-6', 'NAMALWA', 'NB69', 'NCCIT', 'SNU-1', 'SNU-5', 'SNU-16', 'NH-12', 'NKM-1', 'NMC-G1', 'no-11', 'NOMO-1', 'no-10', 'NTERA-2-cl-D1', 'NCI-H747', 'NCI-H716', 'NCI-H1155', 'NCI-H1436', 'NCI-H1581', 'NCI-H1666', 'NCI-H2081', 'NCI-H2196', 'NCI-H524', 'NCI-H748', 'ONS-76', 'OPM-2', 'OS-RC-2', 'P30-OHK', 'P31-FUJ', 'OCUB-M', 'PF-382', 'Raji', 'REH', 'RF-48', 'RKO', 'RPMI-6666', 'RPMI-8402', 'RS4-11', 'SCH', 'SF126', 'SH-4', 'SIG-M5', 'SJSA-1', 'SK-LMS-1', 'SKM-1', 'SK-MEL-1', 'SK-PN-DW', 'SK-UT-1', 'SU-DHL-1', 'SUP-T1', 'SW684', 'SW872', 'SW962', 'TGBC1TKB', 'THP-1', 'TUR', 'U-698-M', 'WSU-NHL', 'RCC10RGB', 'KURAMOCHI', 'KM-H2', 'Ramos-2G6-4C10', 'RPMI-8866', 'QIMR-WIL', 'PSN1', 'CW-2', 'CHP-126', 'CGTH-W-1', 'COLO-320-HSR', 'ATN-1', 'CESS', 'COLO-684', 'COLO-668', 'A388', 'C2BBe1', 'CA46', 'BALL-1', 'BL-41', 'BV-173', 'TGW', 'RL', 'SNU-C1', 'ST486', 'UACC-812', 'SCC-15', 'BC-3', 'BC-1', 'A101D', 'SCC-3', 'AM-38', 'A4-Fuk', 'A3-KAW', 'NEC8', 'CAS-1', 'ALL-PO', 'OCI-AML2', 'MFM-223', 'LS-1034', 'CAL-148', 'HDLM-2', 'KGN', 'KNS-81-FD', 'K5', 'L-363', 'NCI-H1975', 'SW954', 'TE-441-T', 'MMAc-SF', 'MFH-ino', 'NOS-1', 'RL95-2', 'TE-6', 'TE-12', 'YT', 'BT-474', 'KP-N-YS', 'D-247MG', 'D-263MG', 'D-336MG', 'D-392MG', 'D-502MG', 'CTB-1', 'HAL-01', 'OMC-1', 'ES8', 'ES4', 'ES6', 'ES1', 'EW-3', 'EW-12', 'EW-1', 'EW-18', 'EW-16', 'EW-13', 'EW-24', 'LAN-6', 'NB10', 'NB12', 'NB6', 'NB7', 'NB17', 'NB5', 'NB13', 'NB14', 'NB1', 'RH-1', 'MZ2-MEL', 'ES-2', 'MDST8', 'NB(TU)1-10', 'NCI-H1836', 'NCI-H1869', 'NCI-H211', 'NCI-H847', 'TC-71', 'SUP-B15', 'OCI-AML3', 'CL-11', 'ALL-SIL', 'AMO-1', 'COR-L95', 'DND-41', 'EJM', 'Farage', 'NCI-H2135', 'VCaP', 'GA-10', 'GRANTA-519', 'HCC-33', 'Hs-445', 'HSC-39', 'NB4', 'JJN-3', 'JM1', 'JSC-1', 'JURL-MK1', 'KARPAS-231', 'KCL-22', 'KOPN-8', 'L-1236', 'ME-1', 'MOLM-13', 'MOLP-8', 'MY-M12', 'NCI-H1876', 'NK-92MI', 'NU-DUL-1', 'OCI-AML5', 'OCI-LY-19', 'OCI-M1', 'P32-ISH', 'PL-21', 'RC-K8', 'ROS-50', 'SC-1', 'SLVL', 'SU-DHL-16', 'SU-DHL-4', 'SU-DHL-6', 'SU-DHL-8', 'SUP-HD1', 'SUP-M2', 'TK', 'VAL', 'WIL2-NS', 'WSU-DLCL2', 'NCI-H1299', 'HCE-4', 'A498', 'KMS-12-BM', 'NCI-N87', 'SNU-C2B', 'TGBC24TKB', 'A704', 'GAK', 'KLE', 'KP-N-RT-BM-1', 'TE-9', 'TE-11', 'TC-YIK', 'EW-22', 'KYM-1', 'HCC1500', 'KARPAS-620', 'BB65-RCC', 'SW982', 'IA-LM', 'CP67-MEL', 'CRO-AP2', 'MOLT-13', 'NCI-H250', 'PFSK-1', 'A673', '5637', 'RT4', 'SW780', 'TCCSUP', 'C-33-A', 'C-4-I', 'ME-180', '42-MG-BA', 'A172', 'T98G', 'U-118-MG', 'YKG-1', 'ChaGo-K-1', 'Calu-3', 'COR-L23', 'LK-2', 'NCI-H1437', 'NCI-H1623', 'NCI-H1693', 'NCI-H2085', 'NCI-H2170', 'NCI-H2228', 'NCI-H2342', 'NCI-H2347', 'NCI-H2405', 'NCI-H661', 'DMS-273', 'NCI-H1048', 'NCI-H2029', 'NCI-H2052', 'SBC-5', 'LU-135', 'SK-N-SH', 'NCI-H2030', 'NCI-H2122', 'NCI-H1734', 'NCI-H650', 'T24', 'SK-N-AS', 'NCI-H2087', 'UM-UC-3', 'SW756', 'NCI-H727', 'NCI-H1792', 'HPAF-II', 'MIA-PaCa-2', 'NCI-H2009', 'NCI-H2291', 'SW1573', 'HCC1954', 'HCC1395', 'HCC1937', 'HCC38', 'BEN', 'BHY', 'Ca9-22', 'CAL-12T', 'CAL-33', 'CP50-MEL-B', 'EBC-1', 'EPLC-272H', 'HO-1-u-1', 'HSC-2', 'J82', 'KOSC-2', 'KP-4', 'KYSE-140', 'KYSE-410', 'KYSE-520', 'KYSE-70', 'LCLC-103H', 'NCI-H1563', 'NCI-H292', 'PC-14', 'SBC-3', 'CAPAN-1', 'OVCAR-3', 'PC-3', 'DU-145', 'HCT-116', 'HCT-15', 'HT-29', 'NCI-H460', 'NCI-H522', 'T47D', 'MCF7', '786-0', 'A549', 'ACHN', 'BT-549', 'SK-MEL-28', 'SK-MEL-5', 'Hs-578-T', 'SK-OV-3', 'MDA-MB-231', 'COLO-205', 'SW620', 'CAKI-1', 'IGROV-1', 'OVCAR-5', 'HOP-92', 'M14', 'UACC-62', 'SN12C', 'U031', 'U251', 'SF295', 'OVCAR-8', 'BxPC-3', 'BHT-101', 'AGS', 'ABC-1', 'A2058', 'A375', '8305C', '647-V', '639-V', 'BT-20', 'A2780', 'COR-L105', 'COLO-792', 'COLO-680N', 'COLO-679', 'CHP-212', 'CFPAC-1', 'Ca-Ski', 'Caov-3', 'CAL-120', 'CAL-72', 'CAL-62', 'C32', 'Daoy', 'DBTRG-05MG', 'Detroit562', 'DK-MG', 'DoTc2-4510', 'ECC10', 'EFM-19', 'EFO-27', 'FADU', 'FTC-133', 'G-361', 'GAMG', 'GCT', 'ESS-1', 'H4', 'HCC1419', 'HCC1569', 'HCC1806', 'HCC70', 'HEC-1', 'HGC-27', 'HLE', 'HMV-II', 'HOS', 'HSC-3', 'HSC-4', 'HT-1080', 'HT-1197', 'HT-1376', 'HT-3', 'HuCCT1', 'HuH-7', 'HuO9', 'IGR-1', 'IPC-298', 'JEG-3', 'HuP-T3', 'HuP-T4', 'HT55', 'HT-115', 'GP5d', 'DMS-53', 'G-402', 'G-401', 'KU-19-19', 'KYSE-150', 'KYSE-180', 'KYSE-270', 'KYSE-450', 'KYSE-510', 'LoVo', 'LU-99A', 'MC-IXC', 'MDA-MB-175-VII', 'MDA-MB-361', 'MDA-MB-453', 'MDA-MB-468', 'MEL-HO', 'MEL-JUSO', 'MES-SA', 'Mewo', 'MFE-280', 'MFE-296', 'MG-63', 'MHH-ES-1', 'MKN1', 'MKN28', 'MOG-G-CCM', 'MOG-G-UVW', 'NCI-H520', 'NUGC-3', 'NCI-H596', 'NCI-H441', 'NCI-H2452', 'NCI-H1793', 'NCI-H358', 'NCI-H28', 'NCI-H1573', 'NCI-H1703', 'NCI-H1755', 'NCI-H1993', 'P12-ICHIKAWA', 'PA-1', 'OC-314', 'RCM-1', 'RD', 'RMG-I', 'RT-112', 'RVH-421', 'Saos-2', 'SAS', 'SJRH30', 'SK-HEP-1', 'SK-LU-1', 'SK-MEL-3', 'SK-MEL-24', 'SK-MEL-30', 'SK-MES-1', 'SK-MG-1', 'SNG-M', 'SNU-387', 'SNU-423', 'SNU-449', 'SNU-475', 'SW13', 'SW1088', 'SW1417', 'SW1463', 'SW1710', 'SW1783', 'SW48', 'SW626', 'SW837', 'SW948', 'T84', 'TGBC11TKB', 'TYK-nu', 'U-2-OS', 'UACC-893', 'UMC-11', 'VMRC-RCZ', 'YAPC', 'YH-13', 'ZR-75-30', 'HuO-3N1', 'OE19', 'NCI-H838', 'OAW-42', 'OE33', 'COLO-678', 'LN-405', 'BFTC-909', 'SCC-25', 'AsPC-1', 'AU565', 'AN3-CA', 'A204', 'NY', 'C3A', 'A427', 'CAL-85-1', 'CHL-1', 'NCI-H1651', 'RPMI-7951', 'SCC-4', 'SW1990', 'CAPAN-2', 'CAL-27', '769-P', '23132-87', 'A431', 'BFTC-905', 'CAL-51', 'RERF-LC-MS', 'DOK', 'CAL-54', 'EFO-21', '22RV1', '8505C', 'B-CPAP', 'BPH-1', 'CAL-39', 'CaR-1', 'HO-1-N-1', 'HTC-C3', 'MDA-MB-415', 'MKN7', 'MDA-MB-157', 'MKN45', 'NCI-H810', 'PANC-03-27', 'PANC-08-13', 'PANC-10-05', 'RO82-W-1', 'SiHa', 'SKG-IIIa', 'TT', 'VMRC-MELG', 'OAW-28', 'LCLC-97TM1', 'D-423MG', 'D-566MG', 'CAMA-1', 'Caov-4', 'BT-483', 'M059J', 'EW-7', 'LS-180', 'BICR22', 'BICR78', 'CCK-81', 'COLO-783', 'EN', 'FU-OV-1', 'G-MEL', 'NCI-H2591', 'NCI-H2595', 'NCI-H2731', 'NCI-H2803', 'NCI-H2804', 'NCI-H2869', 'NCI-H290', 'NCI-H3118', 'NCI-H513', 'HARA', 'HCC-15', 'HCC-44', 'HCC-827', 'Hep3B2-1-7', 'Hs-633T', 'Hs-683', 'IGR-37', 'IHH-4', 'IM-95', 'JHH-2', 'JHH-4', 'JHH-6', 'JHH-7', 'JHU-011', 'JHU-022', 'KYSE-220', 'LN-18', 'LN-229', 'LNZTA3WT4', 'MDA-MB-436', 'MFE-319', 'ML-1', 'MS751', 'NCI-H1915', 'NCI-H1944', 'NCI-H196', 'NCI-H2023', 'NCI-H3122', 'NCI-H647', 'NCI-H841', 'OSC-20', 'OV-90', 'OVISE', 'OVKATE', 'OVMIU', 'PA-TU-8988T', 'PC-3_[JPC-3]', 'PCI-15A', 'PCI-38', 'PCI-6A', 'PE-CA-PJ15', 'RERF-GC-1B', 'RH-41', 'SISO', 'SKN', 'SNU-398', 'SU8686', 'SUIT-2', 'SW156', 'TOV-21G', 'TT2609-C02', 'VMRC-RCW', 'WM278', 'H3255', '451Lu', 'ASH-3', 'BICR10', 'BICR31', 'CAL-29', 'CAL-78', 'CHSA0011', 'CHSA0108', 'CS1', 'DAN-G', 'EFM-192A', 'FU97', 'G-292-Clone-A141B1', 'NCI-H2369', 'NCI-H2373', 'NCI-H2461', 'NCI-H2722', 'NCI-H2795', 'NCI-H2818', 'HCC1428', 'HCC202', 'HCC-78', 'HDQ-P1', 'HeLa', 'HPAC', 'Hs-766T', 'Hs-939-T', 'Hs-940-T', 'huH-1', 'JHH-1', 'JHU-029', 'JIMT-1', 'K2', 'KMH-2', 'KMRC-1', 'KMRC-20', 'KON', 'KP-1N', 'KP-2', 'KP-3', 'KYSE-50', 'LC-1-sq', 'LOU-NH91', 'NCI-H1435', 'NCI-H1568', 'NCI-H1688', 'NCI-H1781', 'NCI-H2110', 'NCI-H2172', 'NCI-H2444', 'NUGC-4', 'OCUM-1', 'OE21', 'OSC-19', 'OVTOKO', 'PANC-02-03', 'PANC-04-03', 'PA-TU-8902', 'PCI-30', 'PCI-4B', 'PL4', 'RERF-LC-KJ', 'RERF-LC-Sq1', 'RKN', 'SAT', 'SCC90', 'SKN-3', 'STS-0421', 'SW1271', 'T-T', 'TMK-1', 'TOV-112D', 'WM1552C', 'WM35', 'WM793B', 'CHSA8926', 'MDA-MB-330', 'SU-DHL-5', 'SCC-9', 'WM-115', 'Hs-746T', 'SU-DHL-10', 'COR-L311', 'CADO-ES1', 'SW1116', 'CHP-134', 'RH-18', 'COR-L303', 'QGP-1', 'YMB-1-E', 'COR-L321', 'DOV13', 'Hey', 'JHOS-2', 'JHOS-3', 'OV-7', 'OV-17R', 'OV-56', 'OVCA420', 'OVCA433', 'OVK-18', 'PEO1', 'UWB1.289', 'FLO-1', 'OACp4C', 'OACM5-1', 'SK-GT-4', 'ESO26', 'ESO51', 'KYAE-1', 'EMC-BAC-1', 'EMC-BAC-2', 'TE-4', 'NCC021', 'RCC-FG2', 'RCC-JF', 'RCC-JW', 'RCC-ER', 'RCC-AB', 'RCC-MF', 'KMS-11', 'SNU-1040', 'SNU-175', 'SNU-407', 'SNU-61', 'SNU-81', 'SNU-C5', 'KNS-62', 'NCI-H835', 'KATOIII', 'NCI-H1105', 'NCI-H146', 'Jurkat', 'NCI-H2810', 'NCI-H1341', 'NCI-H2066', 'PWR-1E', 'RCH-ACV', 'JHOS-4', 'CML-T1', 'VMRC-LCD', 'NCI-H929', 'HCC1143', 'MHH-CALL-2', 'NCI-H508', 'SK-CO-1', 'SK-MEL-31', 'SUP-B8', 'CMK', 'COR-L279', 'HCC-366', 'JEKO-1', 'KARPAS-1106P', 'MOLM-16', 'SK-GT-2', 'NCC010', 'MM1S', 'OCI-LY7', 'DiFi', 'COR-L32', 'BONNA-12', 'MHH-CALL-4', 'TALL-1', 'D-245MG', 'NCI-H660', 'NCI-H740', 'U-CH2', 'SNU-283']

# st.selectbox('Select A Cell Line', cell_lines)

# dropdown options for cell lines

df = pd.read_csv('../GDSC1and2_w_CellLineData.csv')
model_ic50 = joblib.load("dd_rf_ic50.pkl")
model_auc = joblib.load("dd_rf_auc.pkl")


# prepare dropdown options
cell_mapping = df[['CELL_LINE_NAME', 'COSMIC_ID']].dropna().drop_duplicates()
cell_lines = sorted(cell_mapping['CELL_LINE_NAME'].unique())
selected_cell_line = st.selectbox("Select a Cell Line", cell_lines)

# match selected cell line to cosmic_id
selected_cosmic_id = cell_mapping.loc[cell_mapping['CELL_LINE_NAME'] == selected_cell_line, 'COSMIC_ID'].values[0]

# filter dataset for selected cell line
df_filtered = df[df['COSMIC_ID'] == selected_cosmic_id].copy()

# predict if there are rows available
if df_filtered.empty:
    st.warning("No data found for this cell line.")
else:
    # features for prediction
    X = df_filtered[['DRUG_ID', 'COSMIC_ID']]

    # make predictions
    df_filtered['Pred_ln_IC50'] = model_ic50.predict(X)
    df_filtered['Pred_AUC'] = model_auc.predict(X)

    # plot interactive scatterplot with cell line hover
    fig = px.scatter(
        df_filtered,
        x='Pred_ln_IC50',
        y='Pred_AUC',
        hover_name='DRUG_NAME', 
        title=f"{selected_cell_line} â€” Predicted Cell Line Sensitivity Across Drugs",
        labels={
            'Pred_ln_IC50': 'Predicted ln(IC50)',
            'Pred_AUC': 'Predicted AUC'
        }
    )

    fig.update_traces(marker=dict(size=8, opacity=0.7))
    st.plotly_chart(fig)

